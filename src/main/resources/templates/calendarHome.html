<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brahmavanam</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/rrule@2.6.4/dist/es5/rrule.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.15/index.global.min.js'></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: flex-start;
        }
        .calendar-container {
            margin-left: auto;
            margin-right: 20px;
            width: 100%;
        }

        .fc-toolbar {
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }
        .fc-daygrid-event {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .fc-daygrid-event:hover {
            background-color: #45a049;
        }
        .fc-day-today {
            background-color: #e0f7fa !important;
        }
        .event-form {
            display: none;
            position: absolute;
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .event-form:hover {
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-color: #aaa;
        }
    </style>
</head>
<body>
<div class="calendar-container">
    <div id='calendar'></div>
</div>
<div class="event-form" id="eventForm">
    <h3>Add Event</h3>
    <label for="eventTitle">Title:</label>
    <input type="text" id="eventTitle" name="eventTitle"><br><br>
    <button id="saveEventButton">Save Event</button>
    <button id="cancelEventButton">Cancel</button>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var eventForm = document.getElementById('eventForm');
        var saveEventButton = document.getElementById('saveEventButton');
        var cancelEventButton = document.getElementById('cancelEventButton');
        var selectedInfo = null;

        // Fetch events from the server
        fetch('/events')
            .then(response => response.json())
            .then(events => {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events,
                selectable: true,
                select: function(info) {
                    var startDate = new Date(info.start);
                    var endDate = new Date(info.end);
                    var allowedDays = [0, 1, 4, 5]; // Monday, Tuesday, Friday & Saturday
                    var daysSelected = (endDate - startDate) / (1000 * 60 * 60 * 24);

                    if (daysSelected > 2) {
                        alert('You can only block a maximum of 2 days.');
                        calendar.unselect();
                        return;
                    }

                    if (!allowedDays.includes(startDate.getUTCDay()) || ([1,5].includes(startDate.getUTCDay()) && daysSelected > 1)) {
                        alert('You can only block dates on Monday, Tuesday, Friday, and Saturday.');
                        calendar.unselect();
                        return;
                    }

                    var eventsOnDay = calendar.getEvents().filter(event => {
                        return event.start.getTime() === startDate.getTime();
                    });

                    if (eventsOnDay.length > 0) {
                        alert('Only one booking is allowed per day.');
                        calendar.unselect();
                        return;
                    }

                    selectedInfo = info;
                    var rect = info.jsEvent.target.getBoundingClientRect();
                    eventForm.style.top = (rect.top - eventForm.offsetHeight) + 'px';
                    eventForm.style.left = rect.left + 'px';
                    eventForm.style.display = 'block';
                    calendar.setOption('selectable', false);
                    calendar.setOption('editable', false);
                }
            });
            calendar.render();

            saveEventButton.addEventListener('click', function() {
                var eventTitle = document.getElementById('eventTitle').value;
                if (eventTitle && selectedInfo) {
                    calendar.addEvent({
                        title: eventTitle,
                        start: selectedInfo.start,
                        end: selectedInfo.end,
                        color: '#ffcccc',
                        textColor: '#990000'
                    });
                    eventForm.style.display = 'none';
                    selectedInfo = null;
                    document.getElementById('eventTitle').value = '';
                    calendar.setOption('selectable', true);
                    calendar.setOption('editable', true);
                } else {
                    alert('Please enter an event title.');
                }
            });

            cancelEventButton.addEventListener('click', function() {
                eventForm.style.display = 'none';
                selectedInfo = null;
                calendar.unselect();
                calendar.setOption('selectable', true);
                calendar.setOption('editable', true);
            });
        });
    });
</script>
</body>
</html>