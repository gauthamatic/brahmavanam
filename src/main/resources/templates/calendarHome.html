<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brahmavanam</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/rrule@2.6.4/dist/es5/rrule.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.15/index.global.min.js'></script>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow-y: auto; /* Enable scrolling */
    }
    header {
        background-color: #f4f4f4;
        padding: 10px 20px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
    }
    header h1 {
        margin: 0;
        font-family: Helvetica, sans-serif;
        font-size: 24px;
        display: flex;
        align-items: center;
    }
    .home-button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        margin-left: 10px;
    }
    .home-button:hover {
        background-color: #4CAF49;
        color: white;
    }
    .user-actions {
        position: absolute;
        right: 50px;
        top: 15px;
        display: flex;
        align-items: center;
        gap: 15px; /* Adds spacing between username and buttons */

    }
    .login-button, .logout-button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
    }
    .logout-button:hover, .login-button:hover {
        background-color: #45a049;
    }
    .username {
        color: #333;
        font-size: 16px;
        font-weight: bold;
    }
    .calendar-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        height: calc(100vh - 60px);
        margin-top: 60px; /* Adjust for fixed header */
        overflow-y: auto; /* Enable scrolling within the container */
    }
    #calendar {
        width: 70%;
        height: 100%;
    }
    .fc-toolbar {
        background-color: #f0f0f0;
        border-bottom: 1px solid #ddd;
    }
    .fc-daygrid-event {
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
    }
    .fc-daygrid-event:hover {
        background-color: #45a049;
    }
    .fc-day-today {
        background-color: #e0f7fa !important;
    }
    .fc-day:hover {
        background-color: #f0f0f0; /* Light grey background on hover */
        cursor: pointer; /* Change cursor to pointer */
    }
</style>
</head>

<body>
<header>
    <a href="/home" class="home-button"><h1>BRAHMAVANAM</h1></a>
    <div class="user-actions">
        <a href="/login" class="login-button" th:if="${userName == null}">Login</a>
        <div th:if="${userName != null}" style="display: flex; align-items: center; gap: 10px;">
            <span class="username" th:text="'Hello, ' + ${userName}"></span>
            <a href="/logout" class="logout-button">Logout</a>
        </div>
    </div>
</header>

<div class="calendar-container">
    <div id='calendar' th:attr="data-date=${date != null ? date : ''}"></div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var loggedInUser = null;
        var initialDate = calendarEl.getAttribute('data-date') || new Date().toISOString().split('T')[0];

        // Fetch logged-in user information
        fetch('/user')
            .then(response => response.json())
            .then(user => {
                loggedInUser = user;
                console.log('Logged-in user:', loggedInUser);
            })
            .catch(error => {
                console.error('Error fetching user information:', error);
            });

        // Fetch events from the server
        fetch('/events')
            .then(response => response.json())
            .then(events => {
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    initialDate: initialDate,
                    headerToolbar: {
                        left: 'prevYear,prev,next,nextYear today',
                        center: 'title',
                        right: 'SelectDate dayGridMonth,listMonth'
                    },
                    customButtons: {
                        SelectDate: {
                            text: 'Select Date',
                            click: function() {
                                var selectedDate = prompt('Enter the date (YYYY-MM-DD):');
                                if (selectedDate) {
                                    calendar.gotoDate(selectedDate);
                                } else {
                                    alert('Please enter a valid date.');
                                }
                            }
                        }
                    },

                    events: events,
                    timeZone: 'IST',
                    selectable: true,
                    editable: false, // Disable event editing

                    select: function(info) {
                        if (!loggedInUser) {
                            alert('You must be logged in to create an event.');
                            calendar.unselect();
                            var redirectUrl = '/calendar?date=' + info.startStr;
                            window.location.href = '/login?redirectUrl=' + encodeURIComponent(redirectUrl);
                            return;
                        }

                        var startDate = new Date(info.start);
                        var endDate = new Date(info.end);
                        var allowedDays = [1, 2, 5, 6]; // Monday, Tuesday, Friday & Saturday
                        var daysSelected = (endDate - startDate) / (1000 * 60 * 60 * 24);

                        if (daysSelected > 2) {
                            alert('You can only block a maximum of 2 days.');
                            calendar.unselect();
                            return;
                        }

                        if (!allowedDays.includes(startDate.getUTCDay()) || ([2,6].includes(startDate.getUTCDay()) && daysSelected > 1)) {
                            alert('You can only block dates on Monday, Tuesday, Friday, and Saturday.');
                            calendar.unselect();
                            return;
                        }

                        var eventsOnDay = calendar.getEvents().filter(event => {
                            return event.start.getTime() === startDate.getTime();
                        });

                        if (eventsOnDay.length > 0) {
                            alert('Only one booking is allowed per day.');
                            calendar.unselect();
                            return;
                        }

                        var newEvent = {
                            title: loggedInUser.firstName + ' ' + loggedInUser.lastName,
                            start: info.start,
                            end: info.end,
                            color: '#ffcccc',
                            textColor: '#990000',
                            user: loggedInUser
                        };

                        fetch('/events', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(newEvent)
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(errorResponse => {
                                    throw new Error(errorResponse.error);
                                    });
                            }
                            return response.json();
                        })
                        .then(savedEvent => {
                            if (savedEvent.id) {
                                var addedEvent =  calendar.addEvent(savedEvent);
                                console.log('Event added:', addedEvent);
                                calendar.unselect();
                            } else {
                                console.error('Error: Event ID is missing in the server response');
                                alert('Event ID is missing in the server response');
                            }
                        })
                        .catch(error => {
                            if (error instanceof SyntaxError) {
                                console.error('SyntaxError:', error.message);
                                alert('Unexpected error occurred. Please try again.');
                            } else {
                                console.error('Error Object: ', error);
                                if (error.message.includes('Event start date cannot be in the past.')) {
                                    alert('Those who live in the past are not encouraged at Brahmavanam. Look ahead and select a future date.');
                                } else if (error.message.includes('User must wait at least 90 days between events.')) {
                                    alert('Meditate; Deepen you practices & wait at least 90 days between events.');
                                } else {
                                    alert('Failed to save event: ' + error.message);
                                }
                            }
                        });
                    },
                    eventClick: function(info) {
                        if (confirm('Do you want to delete this event?')) {
                            fetch('/events/' + info.event.id, {
                                method: 'DELETE'
                            }).then(response => {
                                if (response.ok) {
                                    info.event.remove();
                                } else if (response.status === 401) {
                                    alert('Confirm your identity. Please login!!');

                                    window.location.href = '/login';
                                    return;
                                } else if (response.status === 403) {
                                    alert('Reap only what you sow!! Delete only what you create!!');
                                } else {
                                    return response.json().then(errorResponse => {
                                        throw new Error(errorResponse.error);
                                        });
                                }
                            }).catch(error => {
                                console.error('Error deleting event:', error);
                                if (error.message.includes('An event of past belongs to past')) {
                                    alert('An event of past belongs to past. It can neither be modified nor deleted.');
                                } else {
                                alert('Failed to delete event.');
                                }
                            });
                        }
                    }
                });
                calendar.render();
            });
    });
</script>
</body>
</html>